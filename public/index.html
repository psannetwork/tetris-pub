<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Block Battle Royale</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="css/style.css">
  <script src="https://cdn.socket.io/4.8.1/socket.io.min.js" integrity="sha384-mkQ3/7FUtcGyoppY6bz/PORYoGqOl7/aSUMn2ymDOJcapfS6PHqxhRTMh1RR0Q6+" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
</head>
<body>

  <div id="overall-game-wrapper">
    <div id="left-miniboards-group">
      <canvas id="left-miniboards-canvas"></canvas>
    </div>
    <div id="game-container"> <!-- This is the new central block -->
      <div id="game-left-panel">
        <div id="hold-box"></div>
      </div>
      <div id="attack-bar"></div> <!-- Attack bar is now a direct child of game-container -->
      <div id="main-game-board"></div>
      <div id="game-right-panel">
        <div id="next-box"></div>
        <div id="score-display"></div>
        <!-- Menu Button -->
        <button id="menu-button" class="hamburger-menu">
            MENU
        </button>
      </div>
    </div>
    <div id="right-miniboards-group">
      <canvas id="right-miniboards-canvas"></canvas>
    </div>
    <canvas id="effect-canvas"></canvas>
    <canvas id="ui-canvas"></canvas>
  </div>

  <div id="lobby-overlay">
    <div class="overlay-content">
      <h1 class="lobby-title">Block Battle Royale</h1>
      
      <div id="auth-container">
        <div id="login-form">
          <input type="text" id="login-username" placeholder="ユーザー名" class="auth-input">
          <input type="password" id="login-password" placeholder="パスワード" class="auth-input">
          <div class="auth-buttons">
            <button id="login-button" class="lobby-button">ログイン</button>
            <button id="show-signup-button" class="lobby-button">新規登録へ</button>
          </div>
        </div>
        <div id="signup-form" style="display: none;">
          <input type="text" id="signup-username" placeholder="ユーザー名" class="auth-input">
          <input type="password" id="signup-password" placeholder="パスワード" class="auth-input">
          <input type="text" id="signup-nickname" placeholder="ニックネーム (任意)" class="auth-input">
          <div class="auth-buttons">
            <button id="signup-button" class="lobby-button">登録</button>
            <button id="show-login-button" class="lobby-button">ログインへ</button>
          </div>
        </div>
      </div>

      <div id="user-profile-display" style="display: none;">
        <p>ようこそ、 <span id="display-nickname"></span> さん (Rate: <span id="display-rating"></span>)</p>
        <div class="user-profile-buttons">
          <button id="edit-settings-button" class="lobby-button">設定変更</button>
          <button id="logout-button" class="lobby-button">ログアウト</button>
        </div>
      </div>

      <div id="main-menu-buttons" style="display: none;">
        <button id="join-public-match-button" class="lobby-button">公開マッチ</button>
        <button id="create-room-button" class="lobby-button">部屋作成</button>
        <button id="join-room-button" class="lobby-button">部屋IDで参加</button>
        <button id="join-public-spectate-button" class="lobby-button">公開ルーム観戦</button> <!-- NEW -->
      </div>

      <div id="room-info-display" style="display: none;">
        <p>部屋ID: <span id="current-room-id"></span></p>
        <p><span id="room-host-status"></span></p>
        <button id="host-start-game-button" class="lobby-button" style="display: none;">ゲーム開始</button>
      </div>
    </div>
  </div>

  <div id="settings-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <h2>ユーザー設定</h2>
      <div class="settings-grid">
        <div class="settings-section">
          <h3>プロフィール</h3>
          <label>ニックネーム:</label>
          <input type="text" id="settings-nickname">
          <p>現在のレート: <span id="settings-current-rating"></span></p>
        </div>
        
        <div class="settings-section">
          <h3>キーバインド (クリックして入力)</h3>
          <div class="keybind-row">左移動: <button id="kb-left" class="kb-button"></button></div>
          <div class="keybind-row">右移動: <button id="kb-right" class="kb-button"></button></div>
          <div class="keybind-row">ソフトドロップ: <button id="kb-soft" class="kb-button"></button></div>
          <div class="keybind-row">ハードドロップ: <button id="kb-hard" class="kb-button"></button></div>
          <div class="keybind-row">左回転: <button id="kb-rotateCCW" class="kb-button"></button></div>
          <div class="keybind-row">右回転: <button id="kb-rotateCW" class="kb-button"></button></div>
          <div class="keybind-row">ホールド: <button id="kb-hold" class="kb-button"></button></div>
        </div>

        <div class="settings-section">
          <h3>ブロックカラー</h3>
          <div class="color-grid">
            <div class="color-row">I: <input type="color" id="color-I"></div>
            <div class="color-row">J: <input type="color" id="color-J"></div>
            <div class="color-row">L: <input type="color" id="color-L"></div>
            <div class="color-row">O: <input type="color" id="color-O"></div>
            <div class="color-row">S: <input type="color" id="color-S"></div>
            <div class="color-row">T: <input type="color" id="color-T"></div>
            <div class="color-row">Z: <input type="color" id="color-Z"></div>
          </div>
        </div>
      </div>
      <button id="save-settings-button">保存</button>
      <button class="close-modal">閉じる</button>
    </div>
  </div>

  <div id="create-room-modal" class="modal">
    <div class="modal-content">
      <h2>部屋作成</h2>
      <input type="text" id="create-room-password" placeholder="パスワード (任意)">
      <button id="confirm-create-room">作成</button>
      <button class="close-modal">キャンセル</button>
    </div>
  </div>

  <div id="join-room-modal" class="modal">
    <div class="modal-content">
      <h2>部屋IDで参加</h2>
      <input type="text" id="join-room-id" placeholder="部屋ID">
      <input type="password" id="join-room-password" placeholder="パスワード (設定されている場合)">
      <button id="confirm-join-room">参加</button>
      <button class="close-modal">キャンセル</button>
    </div>
  </div>

  <!-- New: Admin Menu Modal -->
  <div id="admin-menu-modal" class="modal">
    <div class="modal-content">
      <h2>ルーム管理</h2>
      <p>部屋ID: <span id="admin-room-id"></span></p>
      <button id="admin-start-game-button" class="lobby-button">ゲーム開始</button>
      <h3 id="member-list-title">現在のメンバー</h3>
      <ul id="member-list"></ul>
      <button id="admin-back-to-lobby-button" class="lobby-button" style="background: #e74c3c;">ロビーに戻る</button>
      <button class="close-modal">閉じる</button>
    </div>
  </div>

  <!-- NEW: Spectate Rooms Modal -->
  <div id="spectate-rooms-modal" class="modal">
    <div class="modal-content">
      <h2>観戦可能な公開ルーム</h2>
      <ul id="public-rooms-list"></ul>
      <p id="no-public-rooms-message" style="display: none;">現在、観戦可能な公開ルームはありません。</p>
      <button class="close-modal">閉じる</button>
    </div>
  </div>

  <!-- NEW: Spectator Menu Modal (for hamburger icon while spectating) -->
  <div id="spectator-menu-modal" class="modal">
    <div class="modal-content">
      <h2>観戦メニュー</h2>
      <h3>現在の順位</h3>
      <div id="spectator-ranking-list"></div>
      <button id="spectator-back-to-lobby-button" class="lobby-button">ロビーに戻る</button>
      <button class="close-modal">閉じる</button>
    </div>
  </div>

  <div id="game-end-overlay">
    <div class="overlay-content">
      <div id="rating-change-display" class="rating-change-container" style="display: none;">
        <span class="rating-label">RATE:</span>
        <span id="rating-old-value"></span>
        <span id="rating-arrow">→</span>
        <span id="rating-new-value"></span>
        <span id="rating-diff-value"></span>
      </div>
      <div id="game-end-title" class="menu-title"></div>
      <div id="final-ranking-list"></div>
      <div class="menu-buttons">
        <button id="retry-button">Play Again</button>
        <button id="spectate-button">観戦する</button> <!-- NEW -->
        <button id="lobby-button">Back to Lobby</button>
      </div>
    </div>
  </div>

  <div id="countdown-overlay" style="display: none !important;"></div>

  <!-- New: Message Display Area -->
  <div id="message-display" style="display: none;"></div>

  <script type="module" src="js/main.js"></script>
</body>
</html>